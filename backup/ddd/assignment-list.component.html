<mat-spinner *ngIf="isLoading"></mat-spinner>
<form [formGroup]="assignmentsForm" *ngIf="!isLoading"></form>

  <table
    *ngIf="!isLoading"
    mat-table
    [dataSource]="dataSource"
    multiTemplateDataRows
    class="mat-elevation-z8"
  >
    <ng-container
      matColumnDef="{{ column }}"
      *ngFor="let column of columnsToDisplay"
    >
      <th mat-header-cell *matHeaderCellDef>
        {{
          column
            .replace('lastUpdate', 'last update')
            .replace('userName', 'user name')
        }}
      </th>
      <div *ngIf="column === 'title'">
        <td mat-cell *matCellDef="let assignment; let j = renderIndex">
          <input
            [style.display]="editIsEnabled ? 'block' : 'none'"
            matInput
            formControlName="title-{{ getFloor(j / 2) }}"
            type="text"
            placeholder="Add a title"
            value="{{ assignment[column] }}"
            #titleInput
          />
          <div [style.display]="editIsEnabled ? 'none' : 'block'">
            {{ titleInput.value }}
          </div>
        </td>
      </div>
      <div *ngIf="column !== 'title'">
        <td mat-cell *matCellDef="let assignment; let j = renderIndex">
          {{ assignment[column] }}
        </td>
      </div>
    </ng-container>
    <!-- Expanded description Column - The detail row is made up of this one column that spans across all columns -->
    <ng-container matColumnDef="expandedDetail">
      <td
        class="button"
        mat-cell
        *matCellDef="let assignment; let i = renderIndex"
        [attr.colspan]="columnsToDisplay.length"
      >
        <div
          class="assignment-detail"
          [@detailExpand]="
            assignment == expandedAssignment ? 'expanded' : 'collapsed'
          "
        >
          <div
            class="assignment-diagram"
            *ngIf="assignment.fileType === 'application/pdf'"
          >
            <span>
              <img [src]="pdfImgPath" />
            </span>
            <span>
              <a
                *ngIf="!filePicked"
                class="pdfThumbnail"
                target="_blank"
                [routerLink]="['/pdfViewer', assignment.filePath]"
                matTooltip="Expand to web viewer"
                ><mat-icon>launch</mat-icon></a
              >
              <a
                *ngIf="filePicked"
                class="pdfThumbnail"
                target="_blank"
                [routerLink]="['/pdfViewer', filePathVar]"
                matTooltip="Expand to web viewer"
                ><mat-icon>launch</mat-icon></a
              >
            </span>
          </div>

          <div
            class="assignment-diagram"
            *ngIf="assignment.fileType !== 'application/pdf'"
          >
            <span>
              <img class="docThumbnail" [src]="docImgPath" />
            </span>
            <span>
              <a
                *ngIf="!filePicked"
                class="pdfThumbnail"
                target="_blank"
                [routerLink]="['/docViewer', assignment.filePath]"
                matTooltip="Expand to web viewer"
                ><mat-icon>launch</mat-icon></a
              >
              <a
                *ngIf="filePicked"
                class="pdfThumbnail"
                target="_blank"
                [routerLink]="['/docViewer', filePathVar]"
                matTooltip="Expand to web viewer"
                ><mat-icon>launch</mat-icon></a
              >
            </span>
          </div>
          <div class="assignment-description">
            <input
              [style.display]="editIsEnabled ? 'block' : 'none'"
              matInput
              formControlName="description-{{ getFloor(i / 2) }}"
              type="text"
              placeholder="Add a description"
              value="assignment.description"
              #descriptionInput
            />

            <div [style.display]="editIsEnabled ? 'none' : 'block'">
              {{ descriptionInput.value }}
            </div>

            <div class="assignment-description-attribution"></div>
            <mat-action-row>
              <a
                *ngIf="editIsEnabled"
                mat-button
                color="theme"
                matTooltip="Upload another file assignment"
                (click)="filePicker.click()"
              >
                <mat-icon> attach_file</mat-icon>
              </a>

              <button
                *ngIf="editIsEnabled"
                mat-button
                color="success"
                (click)="onSaveAssignment(assignment, i / 2)"
                matTooltip="Save the changes"
              >
                <mat-icon>check_circle</mat-icon>
              </button>
              <a
                *ngIf="!editIsEnabled"
                mat-button
                color="primary"
                (click)="permitEdit($event)"
                matTooltip="Edit the assignment's information"
                ><mat-icon>create</mat-icon></a
              >
              <a
                *ngIf="!editIsEnabled"
                mat-button
                color="warn"
                (click)="onDelete(assignment.id)"
                matTooltip="Delete the assignment"
              >
                <mat-icon>delete</mat-icon>
              </a>
              <a
                *ngIf="!editIsEnabled"
                mat-button
                color="theme"
                (click)="onDownload(assignment.filePath)"
                matTooltip="Download the assignment"
              >
                <mat-icon>save_alt</mat-icon>
              </a>
              <input
                formControlName="filePath-{{ getFloor(i / 2) }}"
                type="file"
                #filePicker
                (change)="onFilePicked($event, i / 2)"
              />
            </mat-action-row>
          </div>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
    <tr
      mat-row
      *matRowDef="let assignment; columns: columnsToDisplay"
      class="assignment-row"
      [class.expanded-row]="expandedAssignment === assignment"
      (click)="
        expandedAssignment =
          expandedAssignment === assignment ? null : assignment
      "
    ></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: ['expandedDetail']"
      class="detail-row"
    ></tr>
  </table>
</form>
<div id="add-button">
  <button
    mat-icon-button
    *ngIf="!isLoading"
    routerLink="/create"
    matTooltip="Add an assignment"
  >
    <mat-icon style="color: rgb(83, 83, 233)">add_circle</mat-icon>
  </button>
</div>
<mat-paginator
  [length]="totalassignments"
  [pageSize]="assignmentsPerPage"
  [pageSizeOptions]="pageSizeOptions"
  (page)="onChangePage($event)"
  *ngIf="assignments.length > 0"
></mat-paginator>
<p class="mat-body-1 info-text" *ngIf="assignments.length <= 0 && !isLoading">
  <mat-card class="message">
    <span>No assignments added yet!</span>
  </mat-card>
</p>


  <div
    formArrayName="assignmentsFormArray"
    *ngFor="
      let item of assignmentsForm.get('assignmentsFormArray')['controls'];
      let i = index
    "
  >
    <div [formGroupName]="i">
      <input formControlName="title" placeholder="Item name" />
      <input formControlName="description" placeholder="Item description" />
      <input formControlName="filePath" placeholder="Item price" />
    </div>
    Exposed item name:
    {{
      assignmentsForm.controls.assignmentsFormArray.controls[i].controls.title
        .value
    }}
  </div>
  <button type="button" (click)="addItem()">Add Item</button>
</form>
